<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Laptops</title>
    <script>
        async function checkAuth() {
            let response = await fetch("/admin/check-auth");
            if (response.status !== 200) {
                document.getElementById("login-container").style.display = "block";
                document.getElementById("admin-container").style.display = "none";
            } else {
                document.getElementById("login-container").style.display = "none";
                document.getElementById("admin-container").style.display = "block";
                loadLaptops();
            }
        }

        async function login() {
            let username = document.getElementById("username").value;
            let password = document.getElementById("password").value;

            let response = await fetch("/admin/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            });

            if (response.status === 200) {
                checkAuth();
            } else {
                alert("Invalid login credentials");
            }
        }

        async function logout() {
            await fetch("/admin/logout");
            checkAuth();
        }

        async function loadLaptops() {
            let response = await fetch("/admin/laptops");
            let laptops = await response.json();
            let table = document.getElementById("laptops");
            table.innerHTML = "<tr><th>Brand</th><th>Model</th><th>Price</th><th>Processor</th><th>RAM</th><th>Storage</th><th>Graphics</th><th>Availability</th><th>Actions</th></tr>";
            laptops.forEach(laptop => {
                table.innerHTML += `
                    <tr>
                        <td>${laptop.brand}</td>
                        <td>${laptop.model}</td>
                        <td>${laptop.price}</td>
                        <td>${laptop.processor}</td>
                        <td>${laptop.ram}</td>
                        <td>${laptop.storage}</td>
                        <td>${laptop.graphics}</td>
                        <td>${laptop.availability ? "‚úÖ" : "‚ùå"}</td>
                        <td>
                            <button onclick="updateLaptop('${laptop._id}')">Update</button>
                            <button onclick="deleteLaptop('${laptop._id}')">Delete</button>
                        </td>
                    </tr>`;
            });
        }

        async function addLaptop() {
            let laptop = {
                brand: document.getElementById("brand").value,
                model: document.getElementById("model").value,
                price: document.getElementById("price").value,
                processor: document.getElementById("processor").value,
                ram: document.getElementById("ram").value,
                storage: document.getElementById("storage").value,
                graphics: document.getElementById("graphics").value,
                availability: document.getElementById("availability").checked
            };
            await fetch("/admin/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(laptop)
            });
            loadLaptops();
        }

        async function deleteLaptop(id) {
            await fetch(`/admin/delete/${id}`, { method: "POST" });
            loadLaptops();
        }

        async function updateLaptop(id) {
            let updatedLaptop = {
                brand: prompt("Enter new brand:"),
                model: prompt("Enter new model:"),
                price: prompt("Enter new price:"),
                processor: prompt("Enter new processor:"),
                ram: prompt("Enter new RAM:"),
                storage: prompt("Enter new storage:"),
                graphics: prompt("Enter new graphics:"),
                availability: confirm("Is the laptop available?")
            };
            if (updatedLaptop.brand && updatedLaptop.model) {
                await fetch(`/admin/update/${id}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updatedLaptop)
                });
                loadLaptops();
            }
        }

        window.onload = checkAuth;
    </script>
</head>
<body>

    <!-- üîπ Login Form -->
    <div id="login-container" style="display: none;">
        <h2>Admin Login</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
    </div>

    <!-- üîπ Admin Panel (Hidden Until Logged In) -->
    <div id="admin-container" style="display: none;">
        <h2>Admin Panel - Laptops</h2>
        <button onclick="logout()">Logout</button>
        <table border="1" id="laptops"></table>

        <h3>Add New Laptop</h3>
        <input type="text" id="brand" placeholder="Brand">
        <input type="text" id="model" placeholder="Model">
        <input type="number" id="price" placeholder="Price">
        <input type="text" id="processor" placeholder="Processor">
        <input type="text" id="ram" placeholder="RAM">
        <input type="text" id="storage" placeholder="Storage">
        <input type="text" id="graphics" placeholder="Graphics">
        <label>
            <input type="checkbox" id="availability"> Available
        </label>
        <button onclick="addLaptop()">Add</button>
        <h2>üìä Best-Selling Laptops</h2>
<canvas id="bestSellingChart" style="max-width: 400px; max-height: 300px;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    async function fetchBestSelling() {
        try {
            const response = await fetch("/admin/best-selling");
            const data = await response.json();

            const labels = data.map(item => item.laptop);
            const values = data.map(item => item.totalSold);

            const ctx = document.getElementById("bestSellingChart").getContext("2d");
            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Units Sold",
                        data: values,
                        backgroundColor: "rgba(75, 192, 192, 0.5)",
                        borderColor: "rgba(75, 192, 192, 1)",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Error fetching best-selling laptops:", error);
        }
    }

    fetchBestSelling();
</script>

    </div>

</body>
</html>
